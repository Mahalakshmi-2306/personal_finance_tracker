<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Summary | Finance Tracker</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: #f9f9f9;
    }

    .hero-title {
      text-align: center;
      padding: 2rem 0 1rem;
    }

    .hero-title h1 {
      font-family: 'Quicksand', sans-serif;
      font-size: 2.8rem;
      margin: 0;
      color: #444;
    }

    .hero-title .tagline {
      font-size: 1.1rem;
      color: #777;
      margin-top: 0.5rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background-color: #007bff;
      color: white;
    }

    header h1 {
      font-size: 1.5rem;
      margin: 0;
    }

    nav a,
    nav button {
      margin-left: 1rem;
      color: white;
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      text-decoration: none;
    }

    .background-brand-text {
      position: absolute;
      top: 20%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Quicksand', sans-serif;
      font-size: 6rem;
      color: rgba(0, 0, 0, 0.04);
      pointer-events: none;
      user-select: none;
      white-space: nowrap;
      z-index: 0;
    }

    body.dark .background-brand-text {
      color: rgba(255, 255, 255, 0.05);
    }

    main {
      padding: 2rem;
      position: relative;
      z-index: 1;
    }

    .filter-section {
      margin: 1.5rem 0 2rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      align-items: center;
    }

    .filter-section label {
      font-weight: 500;
    }

    .summary-box {
      text-align: center;
      background-color: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 3rem;
    }

    .summary-box h2 {
    margin-bottom: 1rem;
    font-family: 'Poppins', sans-serif;
    color: #333; /* Add this */
    }

    body.dark .summary-box h2 {
    color: #333; /* For dark mode */
    }

    #summaryData p {
      margin: 0.3rem 0;
      font-size: 1.05rem;
      color: #333;
    }

    .charts-section {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      justify-content: center;
    }

    .charts-section canvas {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    

  </style>
</head>
<body>
  <section class="hero-title">
    <h1>Budget Buddy</h1>
    <p class="tagline">Track, plan, and grow smarter ðŸŒ±</p>
  </section>

  <header>
    <h1>Finance Summary</h1>
    <nav>
      <a href="/dashboard">Dashboard</a>
      <button id="themeToggle">ðŸŒ“</button>
      <a href="/logout">Logout</a>
    </nav>
  </header>

  <div class="background-brand-text">Budget Buddy</div>

  <main class="summary-section">
    <div class="filter-section">
      <label for="monthFilter">Month:</label>
      <select id="monthFilter">
        <option value="">All</option>
        <option value="0">January</option>
        <option value="1">February</option>
        <option value="2">March</option>
        <option value="3">April</option>
        <option value="4">May</option>
        <option value="5">June</option>
        <option value="6">July</option>
        <option value="7">August</option>
        <option value="8">September</option>
        <option value="9">October</option>
        <option value="10">November</option>
        <option value="11">December</option>
      </select>

      <label for="yearFilter">Year:</label>
      <select id="yearFilter">
        <option value="">All</option>
        <!-- JS will populate -->
      </select>
    </div>

    <div class="summary-box">
      <h2>Summary</h2>
      <div id="summaryData"></div>
    </div>

    <div class="charts-section">
      <canvas id="pieChart"></canvas>
      <canvas id="barChart"></canvas>
      <canvas id="lineChart"></canvas>
    </div>
  </main>

  <script>
    let allTransactions = [];

    document.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark");
      }

      document.getElementById("themeToggle").addEventListener("click", () => {
        document.body.classList.toggle("dark");
        localStorage.setItem("darkMode", document.body.classList.contains("dark"));
      });

      fetch('/transactions')
        .then(res => res.json())
        .then(data => {
          allTransactions = data;
          populateYearFilter();
          updateSummaryAndCharts();
        });

      document.getElementById("monthFilter").addEventListener("change", updateSummaryAndCharts);
      document.getElementById("yearFilter").addEventListener("change", updateSummaryAndCharts);
    });

    function populateYearFilter() {
      const years = [...new Set(allTransactions.map(tx => new Date(tx.date).getFullYear()))].sort((a, b) => b - a);
      const yearSelect = document.getElementById("yearFilter");

      years.forEach(year => {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      });
    }

    function updateSummaryAndCharts() {
      const selectedMonth = document.getElementById("monthFilter").value;
      const selectedYear = document.getElementById("yearFilter").value;

      const filteredData = allTransactions.filter(tx => {
        const txDate = new Date(tx.date);
        const txMonth = txDate.getMonth();
        const txYear = txDate.getFullYear();

        return (selectedMonth === "" || txMonth == selectedMonth) &&
               (selectedYear === "" || txYear == selectedYear);
      });

      let income = 0, expense = 0;
      filteredData.forEach(tx => {
        const amt = parseFloat(tx.amount);
        if (tx.type === 'Income') income += amt;
        else expense += amt;
      });

      document.getElementById("summaryData").innerHTML = `
        <p>Total Income: â‚¹${income.toFixed(2)}</p>
        <p>Total Expense: â‚¹${expense.toFixed(2)}</p>
        <p><strong>Net Balance: â‚¹${(income - expense).toFixed(2)}</strong></p>
      `;

      if (window.pieChartInstance) window.pieChartInstance.destroy();
      if (window.barChartInstance) window.barChartInstance.destroy();
      if (window.lineChartInstance) window.lineChartInstance.destroy();

      window.pieChartInstance = new Chart(document.getElementById("pieChart"), {
        type: 'pie',
        data: {
          labels: ['Income', 'Expense'],
          datasets: [{
            data: [income, expense],
            backgroundColor: ['#4caf50', '#f44336']
          }]
        },
        options: {
          plugins: {
            legend: {
              labels: { color: '#333', font: { size: 14 } }
            }
          }
        }
      });

      const categoryTotals = {};
      filteredData.forEach(tx => {
        if (tx.type === 'Expense') {
          categoryTotals[tx.category] = (categoryTotals[tx.category] || 0) + parseFloat(tx.amount);
        }
      });

      window.barChartInstance = new Chart(document.getElementById("barChart"), {
        type: 'bar',
        data: {
          labels: Object.keys(categoryTotals),
          datasets: [{
            label: 'Expenses',
            data: Object.values(categoryTotals),
            backgroundColor: '#2196f3'
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, ticks: { color: '#555' } },
            x: { ticks: { color: '#555' } }
          },
          plugins: {
            legend: { labels: { color: '#333' } }
          }
        }
      });

      const monthlyExpenses = new Array(12).fill(0);
      allTransactions.forEach(tx => {
        if (tx.type === 'Expense') {
          const date = new Date(tx.date);
          const month = date.getMonth();
          const year = date.getFullYear();
          if (selectedYear === "" || year == selectedYear) {
            monthlyExpenses[month] += parseFloat(tx.amount);
          }
        }
      });

      window.lineChartInstance = new Chart(document.getElementById("lineChart"), {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          datasets: [{
            label: 'Monthly Expense Trend',
            data: monthlyExpenses,
            borderColor: '#ff9800',
            backgroundColor: 'rgba(255, 152, 0, 0.2)',
            tension: 0.3,
            fill: true,
            pointBackgroundColor: '#ff5722',
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, ticks: { color: '#555' } },
            x: { ticks: { color: '#555' } }
          },
          plugins: {
            legend: { labels: { color: '#333' } }
          }
        }
      });
    }
  </script>
</body>
</html>
